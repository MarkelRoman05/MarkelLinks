name: Auto update links and push

on:
  schedule:
    - cron: "50 12 * * *"  # 13:50h todos los días (UTC+1)
    - cron: "30 16 * * 0,6"  # 17:30h sábados y domingos (UTC+1)
    - cron: "0 18 * * 0,6"  # 19:00h sábados y domingos (UTC+1)
  workflow_dispatch:

jobs:
  update-links:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Ejecuta actualización y log
        run: node scripts/actualizar_links.js

      - name: ¿Hubo cambios en links.json?
        id: changes
        run: |
          if git diff --name-only src/assets/links.json | grep -q 'links.json'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Publica resumen GitHub Job Summary
        if: steps.changes.outputs.changed == 'true'
        run: |
          echo "## Cambios en links.json" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f logs/summary.txt ]; then
            sed 's/^/- /' logs/summary.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "- Sin resumen disponible." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit y push con rebase (si hay cambios)
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add src/assets/links.json
          git commit -m "chore: auto-update links.json [skip ci]"
          git pull --rebase origin master
          git push